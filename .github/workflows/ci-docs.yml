name: CI for AIDA-PVA Documentation

on:
  push:
    paths:
      - .github/workflows/ci-docs.yml
      - src/main/java/**
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout aida-pva-tests
        uses: actions/checkout@v2
        with:
          submodules: true
          path: aida-pva-tests
      - name: Checkout aida-pva
        uses: actions/checkout@v2
        with:
          repository: slaclab/aida-pva
          path: aida-pva
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Go to aida-pva dir
        continue-on-error: false
        run: |
          ls ..
          cd ../aida-pva
          mkdir root
      - name: Maven Build & Test (also gets lombok)
        continue-on-error: false
        run: mvn install
      - name: De-lombok tests
        continue-on-error: false
        run: |
          java -jar ~/.m2/repository/org/projectlombok/lombok/1.18.20/lombok-1.18.20.jar delombok ../aida-pva-tests/src/main/java -d root/test/java
      - name: De-lombok src
        continue-on-error: false
        run: |
          java -jar ~/.m2/repository/org/projectlombok/lombok/1.18.20/lombok-1.18.20.jar delombok src -d root
      - name: Generate Documentation
        uses: mattnotmitt/doxygen-action@v1
        with:
          working-directory: '.'
          doxyfile-path: 'docs/doxygenConfig'
      - name: Deploy Documentation
        uses: burnett01/rsync-deployments@5.1
        with:
          switches: -avzr --delete
          path: docGen/html/
          remote_path: /afs/slac/www/grp/cd/soft/aida/aida-pva/
          remote_host: rhel6-64a.slac.stanford.edu
          remote_user: sly
          remote_key: ${{ secrets.DEPLOY_KEY }}
